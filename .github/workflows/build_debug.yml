name: ChainedDecos Debug Build

on:
  pull_request:
    branches:
      - main
      - develop
      - chained-gui
      - refactor-branch
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag name (e.g., v1.0.0)"
        required: true
        type: string
      release_name:
        description: "Release name"
        required: true
        type: string
  push:
    tags:
      - "v*"
    paths:
      - "src/**/*.cpp"
      - "src/**/*.h"
      - "include/**/*.h"
      - "CMakeLists.txt"
      - ".github/workflows/build_debug.yml"

env:
  CI: true

jobs:
  release:
    name: Create Release (${{ matrix.os }}, ${{ matrix.name }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
            extension: ""
            generator: "Ninja"

          - os: windows-latest
            name: windows
            extension: ".exe"
            generator: "Ninja"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Fast parallel submodules
        shell: bash
        run: |
          git submodule update --init --recursive --depth 1 --jobs 8

      - name: Setup ccache
        uses: actions/cache@v3
        with:
          path: |
            ~/.ccache
            ${{ runner.os == 'Windows' && 'C:/ccache' || '~/.ccache' }}
            build/_deps
            build/CMakeFiles
          key: release-${{ matrix.os }}-${{ github.sha }}
          restore-keys: |
            release-${{ matrix.os }}-
            release-

      - name: Get version from tag
        shell: bash
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tag_name }}" ]; then
            VERSION="${{ github.event.inputs.tag_name }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"

      - name: Set up build environment
        shell: bash
        id: build-env
        run: |
          echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"
          echo "package-dir=${{ github.workspace }}/package" >> "$GITHUB_OUTPUT"

      # Linux setup
      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build \
            libgl1-mesa-dev libx11-dev libxrandr-dev libxinerama-dev \
            libxcursor-dev libxi-dev libasound2-dev libglu1-mesa-dev \
            libwayland-dev libxkbcommon-dev libegl1-mesa-dev \
            pkg-config ccache libgtk-3-dev libdrm-dev libgbm-dev \
            libxext-dev libxfixes-dev libxrender-dev libxcomposite-dev \
            libxdamage-dev libxtst-dev libxss-dev libgconf-2-4

      # Windows setup
      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-2022'
        run: |
          choco install cmake ninja ccache --no-progress

      - name: Clear CMake cache
        shell: bash
        run: |
          echo "ðŸ§¹ Starting comprehensive cache cleanup..."
          rm -rf "${{ steps.build-env.outputs.build-output-dir }}" ".deps" \
                 "${{ github.workspace }}/.deps" "${{ github.workspace }}/build"

          find "${{ github.workspace }}" -name "CMakeCache.txt" -delete 2>/dev/null || true
          find "${{ github.workspace }}" -name "CMakeFiles" -type d -exec rm -rf {} + 2>/dev/null || true
          find "${{ github.workspace }}" -name "cmake_install.cmake" -delete 2>/dev/null || true
          find "${{ github.workspace }}" -name "_deps" -type d -exec rm -rf {} + 2>/dev/null || true

          if [[ "${{ matrix.os }}" == "windows-2022" ]]; then
            echo "Performing Windows-specific cleanup..."
            find "${{ github.workspace }}" -name "*.vcxproj" -delete 2>/dev/null || true
            find "${{ github.workspace }}" -name "*.sln" -delete 2>/dev/null || true
            find "${{ github.workspace }}" -name ".vs" -type d -exec rm -rf {} + 2>/dev/null || true
            find "${{ github.workspace }}" -name "Debug" -type d -exec rm -rf {} + 2>/dev/null || true
            find "${{ github.workspace }}" -name "Release" -type d -exec rm -rf {} + 2>/dev/null || true
          fi
          echo "CMake cache cleared completely"

      - name: Create build and package directories
        run: |
          mkdir -p "${{ steps.build-env.outputs.build-output-dir }}"
          mkdir -p "${{ steps.build-env.outputs.package-dir }}"

      - name: Configure CMake for release
        shell: bash
        run: |
          echo "Configuring CMake for release build on ${{ matrix.os }}"
          if [[ "${{ matrix.os }}" == "windows-2022" ]]; then
            GENERATOR="Ninja"
          else
            GENERATOR="Ninja"
          fi
          cmake -B "${{ steps.build-env.outputs.build-output-dir }}" \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_INSTALL_PREFIX="${{ steps.build-env.outputs.package-dir }}" \
            -DBUILD_TESTS=OFF \
            -DBUILD_MAP_EDITOR=ON \
            -DENABLE_OPTIMIZATIONS=OFF \
            -DENABLE_UNITY_BUILD=OFF \
            -DENABLE_WARNINGS=OFF \
            -DENABLE_DEV_TOOLS=OFF \
            -DENABLE_DEBUG_INFO=ON \
            -DCPACK_PACKAGE_VERSION="${{ steps.version.outputs.version }}" \
            -S "${{ github.workspace }}"

      - name: Build Debug binaries
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-2022" ]]; then
            PARALLEL_JOBS=8
          else
            PARALLEL_JOBS=$(nproc 2>/dev/null || echo 4)
          fi
          echo "Building release targets with $PARALLEL_JOBS parallel jobs..."
          cmake --build "${{ steps.build-env.outputs.build-output-dir }}" \
            --config Debug \
            --target ChainedEditor EngineTests \
            --parallel "$PARALLEL_JOBS"

      - name: Run Tests (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          xvfb-run ./build/tests/EngineTests

      - name: Run Tests (Windows)
        if: matrix.os == 'windows-2022'
        shell: pwsh
        run: |
          $testExe = Get-ChildItem -Path build -Filter EngineTests.exe -Recurse | Select-Object -First 1 -ExpandProperty FullName
          if ($testExe) { & $testExe } else { exit 1 }

      - name: Install to package directory
        shell: bash
        run: |
          cmake --install "${{ steps.build-env.outputs.build-output-dir }}" \
            --config Debug \
            --component Runtime

      - name: Package binaries
        shell: bash
        run: |
          cd "${{ steps.build-env.outputs.package-dir }}"
          PACKAGE_NAME="ChainedDecos-${{ steps.version.outputs.version }}-${{ matrix.name }}"
          echo "ðŸ“¦ Creating package: $PACKAGE_NAME"
          if [[ "${{ matrix.os }}" == "windows-2022" ]]; then
            powershell -Command "
              Compress-Archive -Path 'bin/*','share/' -DestinationPath '${{ steps.build-env.outputs.package-dir }}/$PACKAGE_NAME.zip' -Force
            "
          else
            tar -czf "${{ steps.build-env.outputs.package-dir }}/$PACKAGE_NAME.tar.gz" \
              -C bin . -C ../share .
          fi
          echo "âœ… Package created"

      - name: Create source code archive
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        run: |
          echo "ðŸ“¦ Creating source code archive..."
          SOURCE_ARCHIVE="ChainedDecos-${{ steps.version.outputs.version }}-source.zip"
          zip -r "${{ steps.build-env.outputs.package-dir }}/$SOURCE_ARCHIVE" \
            . -x "*.git*" "build*" ".deps*" "cmake-build*" "*.tmp" "*.temp" \
            ".vscode/settings.json" ".vs/*" "*/__pycache__/*" "*.pyc"
          echo "âœ… Created source archive: $SOURCE_ARCHIVE"

      - name: Upload release assets
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.name }}
          path: |
            ${{ steps.build-env.outputs.package-dir }}/*.zip
            ${{ steps.build-env.outputs.package-dir }}/*.tar.gz
          retention-days: 30

      - name: Create release tag
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          TAG="v$(date +'%Y.%m.%d.%H%M%S')"
          git tag $TAG
          git push origin $TAG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish debugrelease to GitHub
        if: matrix.os == 'ubuntu-22.04'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Release ${{ steps.version.outputs.version }}"
          files: |
            ${{ steps.build-env.outputs.package-dir }}/*.zip
            ${{ steps.build-env.outputs.package-dir }}/*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
