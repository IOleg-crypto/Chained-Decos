name: CI

on:
  push:
    branches: [main, develop, chained-gui, refactor-branch]
    paths:
      - "**/*.cpp"
      - "**/*.h"
      - "**/CMakeLists.txt"
      - "**/CMakePresets.json"
      - ".github/workflows/ci.yml"
  pull_request:
    branches: [main, develop, chained-gui, refactor-branch]
  workflow_dispatch:

env:
  CI: true

jobs:
  build:
    name: ${{ matrix.os }} / ${{ matrix.preset }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            preset: linux-gcc-debug
            config_preset: linux-gcc-debug
          - os: ubuntu-latest
            preset: linux-gcc-release
            config_preset: linux-gcc-release
          - os: ubuntu-latest
            preset: linux-clang-debug
            config_preset: linux-clang-debug
          - os: ubuntu-latest
            preset: linux-clang-release
            config_preset: linux-clang-release
          - os: windows-latest
            preset: windows-ninja-debug
            config_preset: windows-ninja-debug
          - os: windows-latest
            preset: windows-ninja-release
            config_preset: windows-ninja-release
          - os: windows-latest
            preset: windows-vs2022-debug
            config_preset: windows-vs2022
          - os: windows-latest
            preset: windows-vs2022-release
            config_preset: windows-vs2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            C:/ccache
            build/${{ matrix.config_preset }}/_deps
          key: ${{ runner.os }}-${{ matrix.config_preset }}-${{ hashFiles('**/CMakeLists.txt', 'CMakePresets.json') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.config_preset }}-

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build ccache \
            libgl1-mesa-dev libx11-dev libxrandr-dev libxinerama-dev \
            libxcursor-dev libxi-dev libasound2-dev libglu1-mesa-dev \
            pkg-config libgtk-3-dev libdrm-dev libgbm-dev \
            xvfb libxkbcommon-x11-0

      - name: Setup Linux Compilers
        if: runner.os == 'Linux'
        run: |
          if [[ "${{ matrix.preset }}" == *"gcc"* ]]; then
            sudo apt-get install -y gcc-14 g++-14
            echo "CC=gcc-14" >> $GITHUB_ENV
            echo "CXX=g++-14" >> $GITHUB_ENV
          elif [[ "${{ matrix.preset }}" == *"clang"* ]]; then
            # Use libc++ to avoid conflicts with GCC 14 headers in C++23 mode
            sudo apt-get install -y clang-18 clang++-18 libc++-18-dev libc++abi-18-dev
            echo "CC=clang-18" >> $GITHUB_ENV
            echo "CXX=clang++-18" >> $GITHUB_ENV
          fi

      - name: Install Windows Dependencies
        if: runner.os == 'Windows'
        run: |
          choco install cmake ninja ccache --no-progress

      - name: Configure
        run: |
          extra_flags=""
          if [[ "${{ matrix.preset }}" == *"clang"* ]]; then
            extra_flags="-DCMAKE_CXX_FLAGS=-stdlib=libc++ -DCMAKE_EXE_LINKER_FLAGS=-stdlib=libc++"
          fi
          
          # Only override compilers on Linux to match installed versions
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            extra_flags="$extra_flags -DCMAKE_C_COMPILER=$CC -DCMAKE_CXX_COMPILER=$CXX"
          fi

          cmake --preset ${{ matrix.config_preset }} \
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/install" \
            -DCH_CI=ON \
            $extra_flags

      - name: Build
        run: |
          cmake --build --preset ${{ matrix.preset }} --parallel $(nproc 2>/dev/null || echo 8)

      - name: Test
        run: |
          config="Release"
          if [[ "${{ matrix.preset }}" == *debug* ]]; then config="Debug"; fi
          
          echo "Matrix Preset: ${{ matrix.preset }}"
          echo "Detected Config: $config"
          
          BUILD_DIR="build/${{ matrix.config_preset }}"
          echo "Searching for test binary in $BUILD_DIR..."
          
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            # Search for EngineTests.exe, prioritizing the one matching the configuration
            TEST_BIN=$(find "$BUILD_DIR" -maxdepth 8 -name "EngineTests.exe" | grep -i "$config" | head -n 1)
            if [[ -z "$TEST_BIN" ]]; then
              echo "Binary not found with config grep, falling back to any EngineTests.exe..."
              TEST_BIN=$(find "$BUILD_DIR" -maxdepth 8 -name "EngineTests.exe" | head -n 1)
            fi
          else
            TEST_BIN=$(find "$BUILD_DIR" -maxdepth 8 -name "EngineTests" -type f -executable | head -n 1)
          fi
          
          if [[ -z "$TEST_BIN" ]]; then
            echo "::error::EngineTests not found!"
            echo "Directory contents of $BUILD_DIR:"
            ls -R "$BUILD_DIR" || true
            exit 1
          fi
          
          TEST_DIR=$(dirname "$TEST_BIN")
          TEST_EXE=$(basename "$TEST_BIN")
          
          echo "Running tests: $TEST_BIN (in $TEST_DIR)"
          cd "$TEST_DIR"
          
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            xvfb-run -a "./$TEST_EXE"
          else
            ./"$TEST_EXE"
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-${{ matrix.preset }}
          path: build/${{ matrix.config_preset }}/bin
          retention-days: 7
