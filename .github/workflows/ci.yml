name: CI

on:
  push:
    branches: [main, develop, chained-gui, refactor-branch]
    paths:
      - "**/*.cpp"
      - "**/*.h"
      - "**/CMakeLists.txt"
      - "**/CMakePresets.json"
      - ".github/workflows/ci.yml"
  pull_request:
    branches: [main, develop, chained-gui, refactor-branch]
  workflow_dispatch:

env:
  CI: true

jobs:
  build:
    name: ${{ matrix.os }} / ${{ matrix.preset }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            preset: linux-gcc-debug
            config_preset: linux-gcc-debug
          - os: ubuntu-latest
            preset: linux-gcc-release
            config_preset: linux-gcc-release
          - os: ubuntu-latest
            preset: linux-clang-debug
            config_preset: linux-clang-debug
          - os: ubuntu-latest
            preset: linux-clang-release
            config_preset: linux-clang-release
          - os: windows-latest
            preset: windows-ninja-debug
            config_preset: windows-ninja-debug
          - os: windows-latest
            preset: windows-ninja-release
            config_preset: windows-ninja-release
          - os: windows-latest
            preset: windows-vs2022-debug
            config_preset: windows-vs2022
          - os: windows-latest
            preset: windows-vs2022-release
            config_preset: windows-vs2022

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            C:/ccache
            build/${{ matrix.preset }}/_deps
          key: ${{ runner.os }}-${{ matrix.preset }}-${{ hashFiles('**/CMakeLists.txt', 'CMakePresets.json') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.preset }}-

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build ccache \
            libgl1-mesa-dev libx11-dev libxrandr-dev libxinerama-dev \
            libxcursor-dev libxi-dev libasound2-dev libglu1-mesa-dev \
            pkg-config libgtk-3-dev libdrm-dev libgbm-dev \
            xvfb libxkbcommon-x11-0

      - name: Setup Linux Compilers
        if: runner.os == 'Linux'
        run: |
          if [[ "${{ matrix.preset }}" == *"gcc"* ]]; then
            sudo apt-get install -y gcc-14 g++-14
            echo "CC=gcc-14" >> $GITHUB_ENV
            echo "CXX=g++-14" >> $GITHUB_ENV
          elif [[ "${{ matrix.preset }}" == *"clang"* ]]; then
            # Use libc++ to avoid conflicts with GCC 14 headers in C++23 mode
            sudo apt-get install -y clang-18 clang++-18 libc++-18-dev libc++abi-18-dev
            echo "CC=clang-18" >> $GITHUB_ENV
            echo "CXX=clang++-18" >> $GITHUB_ENV
          fi

      - name: Install Windows Dependencies
        if: runner.os == 'Windows'
        run: |
          choco install cmake ninja ccache --no-progress

      - name: Configure
        run: |
          extra_flags=""
          if [[ "${{ matrix.preset }}" == *"clang"* ]]; then
            extra_flags="-DCMAKE_CXX_FLAGS=-stdlib=libc++ -DCMAKE_EXE_LINKER_FLAGS=-stdlib=libc++"
          fi
          
          # Only override compilers on Linux to match installed versions
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            extra_flags="$extra_flags -DCMAKE_C_COMPILER=$CC -DCMAKE_CXX_COMPILER=$CXX"
          fi

          cmake --preset ${{ matrix.config_preset }} \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install \
            $extra_flags

      - name: Build
        run: |
          cmake --build --preset ${{ matrix.preset }} --parallel $(nproc 2>/dev/null || echo 8)

      - name: Test
        run: |
          config="Release"
          if [[ "${{ matrix.preset }}" == *"debug"* ]]; then config="Debug"; fi
          
          echo "Current working directory: $(pwd)"
          echo "Looking for EngineTests in build/${{ matrix.preset }}/bin..."
          
          # Check paths for both single and multi-config generators
          # Use absolute paths to avoid bash's command lookup ambiguity (exit code 127)
          SEARCH_PATHS=(
            "${{ github.workspace }}/build/${{ matrix.preset }}/bin/EngineTests"
            "${{ github.workspace }}/build/${{ matrix.preset }}/bin/EngineTests.exe"
            "${{ github.workspace }}/build/${{ matrix.preset }}/bin/$config/EngineTests"
            "${{ github.workspace }}/build/${{ matrix.preset }}/bin/$config/EngineTests.exe"
          )
          
          TEST_BIN=""
          for p in "${SEARCH_PATHS[@]}"; do
            if [ -f "$p" ]; then
              TEST_BIN="$p"
              break
            fi
          done
          
          if [ -z "$TEST_BIN" ]; then
            echo "::error::EngineTests not found in any expected location"
            ls -R build/${{ matrix.preset }}/bin || true
            exit 1
          fi
          
          echo "Running tests: $TEST_BIN"
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            xvfb-run "$TEST_BIN"
          else
            "$TEST_BIN"
          fi

      - name: Upload Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-${{ matrix.preset }}
          path: build/${{ matrix.preset }}/bin
          retention-days: 7
