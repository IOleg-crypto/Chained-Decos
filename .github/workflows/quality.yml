name: Code Quality

on:
  workflow_dispatch:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CI: true

jobs:
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install analysis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck clang-tidy-14

      - name: Clear CMake cache
        shell: bash
        run: |
          echo "🧹 Starting comprehensive cache cleanup..."

          rm -rf "${{ steps.build-env.outputs.build-output-dir }}"
          rm -rf ".deps"
          rm -rf "${{ github.workspace }}/.deps"
          rm -rf "${{ github.workspace }}/build"

          echo "📁 Searching for CMake cache files..."
          find "${{ github.workspace }}" -name "CMakeCache.txt" -delete -print 2>/dev/null || true
          find "${{ github.workspace }}" -name "CMakeFiles" -type d -exec rm -rf {} + -print 2>/dev/null || true
          find "${{ github.workspace }}" -name "cmake_install.cmake" -delete -print 2>/dev/null || true
          find "${{ github.workspace }}" -name "_deps" -type d -exec rm -rf {} + -print 2>/dev/null || true

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "🪟 Performing Windows-specific cleanup..."
            find "${{ github.workspace }}" -name "*.vcxproj" -delete -print 2>/dev/null || true
            find "${{ github.workspace }}" -name "*.sln" -delete -print 2>/dev/null || true
            find "${{ github.workspace }}" -name ".vs" -type d -exec rm -rf {} + -print 2>/dev/null || true
            find "${{ github.workspace }}" -name "Debug" -type d -exec rm -rf {} + -print 2>/dev/null || true
            find "${{ github.workspace }}" -name "Release" -type d -exec rm -rf {} + -print 2>/dev/null || true
          fi

          echo "✅ CMake cache cleared completely"

      - name: Create minimal CMake build for analysis
        run: |
          mkdir -p build_analysis
          cd build_analysis

          cmake -DCMAKE_BUILD_TYPE=Debug \
                -DBUILD_TESTS=OFF \
                -DBUILD_BENCHMARKS=OFF \
                -DDISABLE_ALL_WARNINGS=OFF \
                -DENABLE_WARNINGS=ON \
                -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
                ..

      - name: Run cppcheck
        run: |
          echo "🔍 Running cppcheck static analysis..."

          cppcheck \
            --enable=all \
            --std=c++20 \
            --language=c++ \
            --platform=unix64 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unmatchedSuppression \
            --inline-suppr \
            --xml \
            --xml-version=2 \
            src/ 2> cppcheck_results.xml || true

          if [ -f cppcheck_results.xml ]; then
            echo "📊 Cppcheck found $(grep -c '<error ' cppcheck_results.xml) errors"
          fi

      - name: Run clang-tidy
        run: |
          echo "🔍 Running clang-tidy analysis..."

          cd build_analysis
          find ../src -name "*.cpp" -not -path "*/build/*" | head -20 | \
            xargs -I {} clang-tidy-14 {} -p . || true

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: static-analysis-results
          path: |
            cppcheck_results.xml
            build_analysis/
          retention-days: 7

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install security tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flawfinder

      - name: Run security scan
        run: |
          echo "🔒 Running security scan..."

          flawfinder --csv --minlevel=3 src/ > security_scan.csv || true

          if [ -f security_scan.csv ]; then
            echo "📊 Security scan found $(wc -l < security_scan.csv) potential issues"
            cat security_scan.csv
          fi

      - name: Upload security results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: security_scan.csv
          retention-days: 30

  complexity:
    name: Code Complexity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install complexity tools
        run: |
          sudo apt-get update
          sudo apt-get install -y pmccabe

      - name: Analyze code complexity
        run: |
          echo "📊 Analyzing code complexity..."

          find src -name "*.cpp" -o -name "*.c" | \
            xargs pmccabe -v > complexity_report.txt || true

          if [ -f complexity_report.txt ]; then
            echo "📈 Complexity analysis completed"
            cat complexity_report.txt
          fi

      - name: Upload complexity report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: complexity-report
          path: complexity_report.txt
          retention-days: 7
