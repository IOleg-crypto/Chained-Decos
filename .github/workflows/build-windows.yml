name: Build Windows

on:
  workflow_call:
    inputs:
      build_type:
        required: true
        type: string
        default: "Release"

env:
  CI: true

jobs:
  build-msvc:
    name: Windows (${{ inputs.build_type }})
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            C:/ccache
            .deps
          key: windows-msvc-${{ inputs.build_type }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            windows-msvc-${{ inputs.build_type }}-
            windows-msvc-

      - name: Install dependencies
        run: |
          choco install cmake ninja ccache --no-progress

      - name: Configure
        shell: pwsh
        run: |
          cmake -B build `
            -G "Ninja" `
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} `
            -DCMAKE_C_COMPILER_LAUNCHER=ccache `
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache `
            -DBUILD_TESTS=ON `
            -DBUILD_MAP_EDITOR=ON `
            -DDISABLE_ALL_WARNINGS=ON

      - name: Build
        shell: pwsh
        run: |
          cmake --build build `
            --config ${{ inputs.build_type }} `
            --target ChainedEditor EngineTests `
            --parallel 4

      - name: List Build Files (Debug)
        shell: pwsh
        run: |
          Get-ChildItem -Path build -Filter *.exe -Recurse

      - name: Test
        shell: pwsh
        run: |
          $testExe = Get-ChildItem -Path build -Filter EngineTests.exe -Recurse | Select-Object -First 1 -ExpandProperty FullName
          if ($testExe) {
            Write-Host "Running tests: $testExe"
            & $testExe
          } else {
            Write-Error "EngineTests.exe not found!"
            exit 1
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-msvc-${{ inputs.build_type }}
          path: |
            build/editor/ChainedEditor.exe
            build/runtime/ChainedRuntime.exe
            build/tests/EngineTests.exe
          retention-days: 7
