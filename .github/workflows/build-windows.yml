name: Build Windows

on:
  workflow_call:
    inputs:
      build_type:
        required: true
        type: string
        default: "Release"

env:
  CI: true

jobs:
  build-msvc:
    name: Windows (${{ inputs.build_type }})
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            C:/ccache
            .deps
          key: windows-msvc-${{ inputs.build_type }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            windows-msvc-${{ inputs.build_type }}-
            windows-msvc-

      - name: Install dependencies
        run: |
          choco install cmake ninja ccache --no-progress

      - name: Configure
        shell: bash
        run: |
          cmake -B build \
            -G "Ninja" \
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DBUILD_TESTS=ON \
            -DBUILD_MAP_EDITOR=ON \
            -DDISABLE_ALL_WARNINGS=ON

      - name: Build
        shell: bash
        run: |
          cmake --build build \
            --config ${{ inputs.build_type }} \
            --target ChainedEditor EngineTests \
            --parallel 4

      - name: Test
        shell: bash
        run: |
          if [[ -f "build/tests/EngineTests.exe" ]]; then
            ./build/tests/EngineTests.exe
          elif [[ -f "build/bin/EngineTests.exe" ]]; then
             ./build/bin/EngineTests.exe
          else
            echo "EngineTests not found. Check build directory structure."
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-msvc-${{ inputs.build_type }}
          path: |
            build/editor/ChainedEditor.exe
            build/runtime/ChainedRuntime.exe
            build/tests/EngineTests.exe
          retention-days: 7
