name: Build Linux

on:
  pull_request:
    branches:
      - main
      - develop
  workflow_call:
    inputs:
      build_type:
        required: true
        type: string
        default: "Release"

env:
  CI: true

jobs:
  build-gcc:
    name: Linux GCC (${{ inputs.build_type }})
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            .deps
          key: linux-gcc-${{ inputs.build_type }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            linux-gcc-${{ inputs.build_type }}-
            linux-gcc-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build ccache \
            libgl1-mesa-dev libx11-dev libxrandr-dev libxinerama-dev \
            libxcursor-dev libxi-dev libasound2-dev libglu1-mesa-dev \
            libwayland-dev libxkbcommon-dev libegl1-mesa-dev \
            pkg-config libgtk-3-dev libdrm-dev libgbm-dev

      - name: Setup GCC
        run: |
          echo "CC=gcc-11" >> "$GITHUB_ENV"
          echo "CXX=g++-11" >> "$GITHUB_ENV"

      - name: Configure
        run: |
          cmake -B build \
            -G "Ninja" \
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DBUILD_TESTS=ON \
            -DBUILD_MAP_EDITOR=ON \
            -DDISABLE_ALL_WARNINGS=ON

      - name: Build
        run: |
          cmake --build build \
            --config ${{ inputs.build_type }} \
            --target ChainedEditor EngineTests \
            --parallel $(nproc)

      - name: Test
        run: |
          if [[ -f "build/tests/EngineTests" ]]; then
            ./build/tests/EngineTests
          elif [[ -f "build/bin/EngineTests" ]]; then
            ./build/bin/EngineTests
          else
             echo "EngineTests not found."
             exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-gcc-${{ inputs.build_type }}
          path: |
            build/editor/ChainedEditor
            build/runtime/ChainedRuntime
            build/tests/EngineTests
          retention-days: 7

  build-clang:
    name: Linux Clang (${{ inputs.build_type }})
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            .deps
          key: linux-clang-${{ inputs.build_type }}-${{ hashFiles('**/CMakeLists.txt') }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build ccache \
            libgl1-mesa-dev libx11-dev libxrandr-dev libxinerama-dev \
            libxcursor-dev libxi-dev libasound2-dev libglu1-mesa-dev \
            libwayland-dev libxkbcommon-dev libegl1-mesa-dev \
            pkg-config libgtk-3-dev libdrm-dev libgbm-dev

      - name: Setup Clang
        run: |
          echo "CC=clang-14" >> "$GITHUB_ENV"
          echo "CXX=clang++-14" >> "$GITHUB_ENV"

      - name: Configure
        run: |
          cmake -B build \
            -G "Ninja" \
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DBUILD_TESTS=ON \
            -DBUILD_MAP_EDITOR=ON \
            -DDISABLE_ALL_WARNINGS=ON

      - name: Build
        run: |
          cmake --build build \
            --config ${{ inputs.build_type }} \
            --target ChainedEditor EngineTests \
            --parallel $(nproc)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-clang-${{ inputs.build_type }}
          path: |
            build/editor/ChainedEditor
            build/runtime/ChainedRuntime
          retention-days: 7
